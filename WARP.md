# WARP.md

这个文件为 WARP (warp.dev) 提供在此仓库工作时的指导。

---

## 语言要求

**必须使用中文回复用户**。本系统是面向中文用户的私人投资分析系统。

---

## 项目概述

这是一个基于多模型协同的个人投资分析系统，通过 Claude、Codex、Gemini 三个 AI 组成"投资委员会"，提供专业级别的投资分析和决策支持。

**核心理念**：
- 数据必须可靠客观（从 AKShare 实时获取，禁止估算）
- 多模型协同减少偏见（三个 AI 独立分析，提取共识）
- 强制数据驱动（每个建议必须引用 ≥2 个客观数据字段）
- 个性化 + 持续追踪（记住用户的风格和弱点）

---

## 核心命令

### 数据获取（最重要）
```bash
# 获取所有市场数据（需要在 股市信息 目录下运行）
cd 股市信息 && python3 scripts/fetch_market_data.py

# 注意事项：
# 1. 脚本需要约2分钟运行，必须等待完成
# 2. 只能使用脚本JSON输出的价格，禁止估算或假设
# 3. 如果脚本执行失败，必须告知用户"数据获取失败"
```

### Python 环境
```bash
# 安装依赖
pip install akshare pandas

# 如果使用虚拟环境
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
pip install -r requirements.txt  # 如果有 requirements.txt
```

### Skills 同步（Claude ↔ Codex）
```bash
# 同步技能：Claude -> Codex（默认）
./sync_skills.sh

# 同步技能：Codex -> Claude（反向）
./sync_skills.sh --to-claude

# 严格镜像同步（会删除目标中多余的技能）
./sync_skills.sh --mirror
```

---

## 关键架构

### 数据源优先级（极其重要）

```
第一优先：fetch_market_data.py 脚本输出
├── indices      - 主要指数（上证、沪深300、科创50等）
├── holdings     - 持仓行情（价格、涨跌、盈亏）
├── watchlist    - 关注池行情
├── macro        - 宏观数据（PMI、CPI、M2）
├── north_flow   - 北向资金
├── sector       - 行业/概念板块
├── fund_flow    - 行业/概念资金流
├── technicals   - 技术指标（MA/RSI/MACD）
└── news         - 财联社快讯

第二优先：配置文件（用户数据）
├── Holdings.md   - 持仓（成本、数量、买入日期）- 唯一真相源
├── Watchlist.md  - 关注方向
├── Profile.md    - 投资风格（用户自述）
├── Context.md    - 上下文摘要（自动生成）
└── Insight.md    - 用户洞察（AI维护）

第三优先：WebSearch（谨慎使用）
├── 仅用于：政策原文、公司公告、研报观点
├── 必须标注"来源：网络搜索"
└── 价格数据以脚本为准
```

### 数据真实性原则

1. **价格必须来自脚本**：禁止估算、假设、使用记忆数据
2. **脚本失败时明确告知**：禁止使用默认值或编造
3. **来源标注**：所有数据标注来源和获取时间
4. **时效说明**：提醒用户数据可能有15-30分钟延迟

### 六大 Skills 架构

本系统通过 `.claude/skills/` 目录定义了6个核心技能：

1. **`/brief`** - 每日简报
   - 触发词："简报"、"今日市场"、"持仓分析"
   - 流程：运行脚本 → 读取配置 → 分析生成 → 保存到 `Daily/`
   - **必须覆盖全部持仓**，不能遗漏

2. **`/scan`** - 市场扫描
   - 触发词："有什么机会"、"推荐"、"扫描市场"
   - 最多推荐3个标的

3. **`/analyze`** - 个股分析
   - 触发词："分析XX"、"看看XX怎么样"
   - 自动保存到 `Analysis/[代码]-[名称].md`

4. **`/trade`** - 交易记录
   - 触发词："买了"、"卖了"、"加仓"、"减仓"
   - 验证价格（与当前价偏差不超过5%）
   - 更新 `Holdings.md` 和 `trades.md`
   - 更新 `Context.md`

5. **`/review`** - 周期复盘
   - 触发词："复盘"、"回顾"、"这周怎么样"
   - 验证历史建议准确性（30天/90天）
   - 沉淀经验到 `Principles.md`

6. **`/committee`** - 投资委员会（多模型协同）
   - 触发词："开会"、"投资委员会"、"多模型分析"
   - 流程：生成统一输入 → Claude分析 → 引导用户获取其他模型意见 → 提取共识

### 上下文同步机制

- **Context.md**：自动生成的持仓摘要，供各 Skill 和多模型读取
  - 更新时机：`/trade` 执行后自动更新
  - 包含：持仓统计、最近操作、待验证交易、风险提示

- **Insight.md**：AI 观察到的用户特征（由 Claude 维护）
  - 行为模式、心理画像、成长轨迹、决策采纳率
  - 更新时机：交易记录、复盘、简报、投委会、日常对话
  - 使用：每次 skill 执行前读取，提供个性化服务

### 多模型投资委员会架构

```
统一输入层
├── Context.md                              - 持仓上下文
├── Committee/Input/YYYY-MM-DD-Input.md     - 当日输入数据
└── 决策问题                                 - 用户指定的讨论问题

独立观点层
├── Committee/Opinions/Claude.md            - Claude 分析意见
├── Committee/Opinions/Codex.md             - Codex 分析意见
└── Committee/Opinions/Gemini.md            - Gemini 分析意见

共识提取层
├── 强共识 (3/3一致) → 可考虑直接执行
├── 弱共识 (2/3一致) → 参考多数意见
└── 分歧区 (各不相同) → 需用户决策
```

---

## 目录结构要点

```
个人系统/
├── AGENTS.md                  # 系统详细说明（重要参考文档）
├── 使用手册.md                # 用户操作手册
├── WARP.md                    # 本文件
│
├── .claude/
│   └── skills/                # Claude 技能定义（6个 SKILL.md）
│
├── scripts/
│   ├── fetch_market_data.py   # 核心数据获取脚本 v2.0
│   └── [其他脚本]
│
├── Config-Example/            # 配置文件示例
│
└── 股市信息/                  # 用户数据目录（实际运行时）
    ├── Config/                # 配置文件（用户维护）
    │   ├── Holdings.md        # 持仓明细（唯一真相源）
    │   ├── Watchlist.md       # 关注池
    │   ├── Profile.md         # 投资者画像
    │   ├── Principles.md      # 投资原则
    │   ├── Context.md         # 上下文摘要（自动生成）
    │   └── Insight.md         # 用户洞察（AI维护）
    │
    ├── Daily/                 # 每日简报
    ├── Analysis/              # 个股分析报告
    ├── Records/               # 交易记录和复盘
    ├── Committee/             # 多模型决策
    └── scripts/               # 数据获取脚本
```

---

## 分析原则

### 禁止数据罗列
```
❌ 消费ETF -33.29%
✅ 消费ETF深套977天，以旧换新资金主要利好家电汽车对白酒提振有限
```

### 结合用户持仓
```
❌ 铜价创新高，有色板块强势
✅ 你11月买入时有色已涨很多，铜价创新高后今日回调，建议止盈一半
```

### 给可操作建议
```
❌ 建议关注
✅ 如果回调10%可以考虑加仓，分3次买入
```

### 诚实评估风险
```
❌ 科技方向好，可以买入
✅ 科技方向长期正确，但当前估值高位，现在追高风险较大
```

---

## 持仓数据处理

### 禁止硬编码
**绝对禁止**在代码或分析中硬编码任何持仓描述！

### 必读配置文件
执行任何分析前，必须先读取：
- `股市信息/Config/Holdings.md` - 持仓明细（唯一真相源）
- `股市信息/Config/Watchlist.md` - 关注方向
- `股市信息/Config/Profile.md` - 投资者画像
- `股市信息/Config/Insight.md` - 用户洞察

### Holdings.md 解析
- A股持仓：`## A股持仓` 表格
- 港股持仓：`## 港股持仓` 表格
- 基金持仓：`## 基金持仓` 表格
- 表格字段：代码 | 名称 | 市场 | 成本 | 数量 | ... | 买入日期

---

## 技术指标说明

fetch_market_data.py v2.0 为持仓和关注池自动计算技术指标：

- **MA20/MA60**：20日/60日移动平均线
- **RSI14**：14日相对强弱指标
- **MACD**：指数平滑异同移动平均线
- **Volatility_20d**：20日波动率（年化）
- **Momentum_20d**：20日动量
- **52周高低点**：一年内最高价和最低价
- **Price_percentile_1y**：当前价格在一年区间的位置（百分位）
- **Trend**：趋势判断（上升/下降/震荡）

技术指标基于近450天（约一年）的日线收盘价计算。

---

## 开发注意事项

### 运行环境
- Python 3.8+
- 依赖：akshare、pandas
- 时区：Asia/Shanghai（A股交易时间）
- 数据延迟：15-30分钟

### AKShare 数据源
- 行情数据：东方财富
- 宏观数据：国家统计局
- 新闻快讯：财联社电报
- 北向资金：沪深港通
- 所有数据来自公开数据源，无需 API Key

### Skills 同步规则
- Claude 技能目录：`.claude/skills/`
- Codex 技能目录：`~/.codex/skills/`（用户目录下）
- **任何技能新增/修改/删除都必须同步更新两边**
- 同步后建议重启 Codex CLI 或新开会话以加载新技能

### 错误处理
- 脚本失败时必须告知用户，不能使用默认值
- 数据缺失时明确说明，不能假设或估算
- 价格验证失败时（偏差>5%），警告用户并确认

---

## 用户交互模式

### 日常使用
| 用户需求 | 触发方式 |
|---------|----------|
| 看今日市场和持仓 | "简报" 或 `/brief` |
| 找投资机会 | "有什么机会" 或 `/scan` |
| 分析某个标的 | "分析下腾讯" 或 `/analyze 00700` |
| 记录买卖操作 | "今天买了红利ETF" 或 `/trade` |
| 复盘交易决策 | "复盘" 或 `/review` |
| 多模型讨论 | "开会" 或 `/committee` |

### 建议采纳追踪
系统通过 Insight.md 追踪用户对建议的采纳情况：
- 简报建议的执行率
- 投委会共识的采纳率
- 分析建议的结果验证
- 用户行为模式的演变

---

## 重要文档参考

执行任何操作前，建议先阅读：
1. **AGENTS.md** - 系统完整说明和规则
2. **使用手册.md** - 详细的用户操作指南
3. **.claude/skills/[skill]/SKILL.md** - 各个技能的详细执行流程

---

## 风险提示

⚠️ **投资有风险，本系统仅供参考，不构成投资建议。**

AI 分析基于历史数据和模型推理，不能预测未来，请结合自身情况独立判断。所有投资决策由用户自行承担责任。

---

*最后更新：2026-01-19*
